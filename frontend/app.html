<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoWatch | Dashboard</title>
    <!-- TensorFlow.js Script -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="shortcut icon" href="./public/favicon.ico" type="image/x-icon">
    <!-- Google Fonts for a nicer look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Add a subtle animation for new alerts */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-new {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100">

    <!-- ======================= -->
    <!--         NAVBAR          -->
    <!-- ======================= -->
    <nav class="bg-gray-800/80 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-gray-700">
        <!-- Navbar content is correct, no changes needed here -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="flex items-center">
                    <svg class="h-8 w-8 text-cyan-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12.516 2.17a.75.75 0 00-1.032 0L3.32 9.25a.75.75 0 00.516 1.28h.171l.527 4.903a.75.75 0 00.742.667h8.498a.75.75 0 00.742-.667l.527-4.903h.171a.75.75 0 00.516-1.28L12.516 2.17zM11.25 16.5a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z"
                            clip-rule="evenodd" />
                        <path
                            d="M21.75 9.25a.75.75 0 00-1.032-.019l-8.47 7.058a.75.75 0 00-.336.618V19.5a.75.75 0 00.75.75h8.25a.75.75 0 00.75-.75v-9.142a.75.75 0 00-.218-.508z" />
                    </svg>
                    <span class="ml-2 text-2xl font-bold text-white">Echo<span
                            class="text-cyan-400 font-light">Watch</span></span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="app.html"
                        class="bg-gray-700 text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                    <a href="settings.html"
                        class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Settings</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ======================= -->
    <!--      MAIN CONTENT       -->
    <!-- ======================= -->
    <main class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Video Feed Section -->
        <div class="lg:col-span-2 bg-gray-800 rounded-xl p-4 flex flex-col border border-gray-700">
            <!-- Video feed content is correct, no changes needed -->
            <div class="flex items-center mb-4">
                <svg class="h-6 w-6 text-cyan-400 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round"
                        d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z" />
                </svg>
                <h2 class="text-xl font-semibold text-white">Live Feed</h2>
            </div>
            <div class="relative flex-grow bg-black rounded-lg overflow-hidden flex items-center justify-center">
                <video id="video-stream" autoplay playsinline muted class="w-full h-full object-cover"></video>
                <div id="error-message" class="hidden text-center text-red-400 p-4">...</div>
            </div>
        </div>

        <!-- START: Polished Alerts Sidebar -->
        <div class="lg:col-span-1 bg-gray-800 rounded-xl p-4 flex flex-col border border-gray-700">
            <div class="flex items-center mb-4">
                <svg class="h-6 w-6 text-yellow-400 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                </svg>
                <h2 class="text-xl font-semibold text-white">Live Alerts</h2>
            </div>
            <div id="alerts-container" class="flex-grow space-y-3 overflow-y-auto">
                <div id="initial-alert-placeholder"
                    class="p-3 bg-gray-900/80 rounded-lg text-center text-gray-400 border-l-4 border-gray-600">
                    <p>System active. Monitoring for threats...</p>
                </div>
            </div>
        </div>
        <!-- END: Polished Alerts Sidebar -->
    </main>

    <!-- ======================= -->
    <!--       JAVASCRIPT        -->
    <!-- ======================= -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const videoElement = document.getElementById('video-stream');
            const alertsContainer = document.getElementById('alerts-container');
            const liveFeedContainer = videoElement.parentElement;

            // --- AI Configuration -- KEY CHANGES HERE ---
            const MODEL_URL = "/frontend/models/";
            // 1. Correct the threat class to ONLY what your model knows.
            const THREAT_CLASS_NAME = "knife"; // Case-insensitive
            // 2. Lower the confidence threshold to make it easier to trigger a demo.
            const CONFIDENCE_THRESHOLD = 0.70; // 70% confidence

            let model, stream, threatCooldown = false;

            const showLoadingMessage = (message) => {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-overlay';
                loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-black/50 text-white z-10';
                loadingDiv.innerHTML = `<p class="text-lg font-semibold animate-pulse">${message}</p>`;
                liveFeedContainer.appendChild(loadingDiv);
            };

            const hideLoadingMessage = () => {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) loadingOverlay.remove();
            };

            const showThreatAlert = (prediction) => {
                if (threatCooldown) return;
                threatCooldown = true;
                setTimeout(() => { threatCooldown = false; }, 3000); // 3-second cooldown

                const placeholder = document.getElementById('initial-alert-placeholder');
                if (placeholder) placeholder.remove();

                const alertDiv = document.createElement('div');
                alertDiv.className = "alert-new p-3 bg-red-800/80 rounded-lg border-l-4 border-red-500";

                const detectedClass = prediction.className.toUpperCase();
                const confidence = (prediction.probability * 100).toFixed(0);

                alertDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-red-300">!!! THREAT DETECTED !!!</p>
                        <span class="text-xs text-red-300">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <p class="text-sm text-gray-200">
                        Object: <span class="font-semibold">${detectedClass}</span> | Confidence: <span class="font-semibold">${confidence}%</span>
                    </p>
                `;

                alertsContainer.prepend(alertDiv);
            };

            const detectLoop = async () => {
                if (videoElement.readyState >= 3 && model) {
                    const predictions = await model.predict(videoElement);

                    // 3. (FOR DEBUGGING) This will show you what the model sees in the console (F12).
                    console.log('All Predictions:', predictions.map(p => `${p.className}: ${(p.probability * 100).toFixed(1)}%`).join(' | '));

                    for (const p of predictions) {
                        if (p.className.toLowerCase() === THREAT_CLASS_NAME && p.probability > CONFIDENCE_THRESHOLD) {
                            showThreatAlert(p);
                            break;
                        }
                    }
                }
                setTimeout(() => requestAnimationFrame(detectLoop), 300); // Check ~3 times per second
            };

            const initModel = async () => {
                showLoadingMessage("Initializing AI Model...");
                try {
                    const modelURL = MODEL_URL + "model.json";
                    const metadataURL = MODEL_URL + "metadata.json";
                    model = await tmImage.load(modelURL, metadataURL);
                    hideLoadingMessage();
                    detectLoop();
                } catch (error) {
                    console.error("Failed to load model:", error);
                    hideLoadingMessage();
                    showLoadingMessage("Error: Could not load AI model.");
                }
            };

            const startCamera = async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'environment' } });
                    videoElement.srcObject = stream;
                    videoElement.addEventListener('loadeddata', initModel);
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    // Handle camera error display
                }
            };

            startCamera();
        });
    </script>
</body>

</html>